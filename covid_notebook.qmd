---
title: "Carnet de note : impact du covid-19 sur la mobilité en Wallonie"
author: "Azizi Moussa, Dezutter Joy, Fernandez Dany, Fontaine Maréva"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
editor: visual
lang: fr
---

<!--# Ceci est un commentaire. -->

<!--% Ceci est une consigne. Ne jamais modifier ni déplacer les consignes dans le document ! -->

<!--% Complétez le titre et le nom des auteurs (auteur1, auteur2, auteur3 et auteur 4) dans l'entête YAML.-->

## Introduction et but

<!--% Rédigez une courte introduction de 3 ou 5 phrases qui présente vos données. Ajoutez une phrase de but. Vous devez citer la bibliographie en utilisant le formatage Markdown ad hoc et en incluant votre référence au format bibtex dans le fichier references.bib. -->

Google répertorie les données sur la mobilité des communautés en Belgique (Wallonie, Flandre, Bruxelles) pendant le COVID-19 (elles ne sont plus répertoriés depuis le 15/10/2022), celles-ci sont disponibles ici : https://www.google.com/covid19/mobility/. Nous allons analyser ces données en nous concentrant sur les années 2020 et 2021, l'année 2020 ayant été fortement impactée au niveau économique notamment due aux règles au niveau des déplacements et l'année 2021 également mais ayant subit des mesures moins "strictes". Notre objectif est de déterminer l'impact du COVID-19 sur les déplacements des Wallons, pour ce faire nous allons analyser l'évolution de la fréquentation de lieux au cours du temps et également par catégorie (commerces, pharmacies, parcs, lieux de travail,...)

## Matériel et méthodes

<!--% Indiquez ici d'où viennent les données et aussi quel logiciel (et version) vous utilisez pour les analyses. Inspirez-vous des projets déjà réalisés. -->

Les données sur la mobilité des communautés pendant le COVID-19 en Belgique proviennent de Google : https://www.google.com/covid19/mobility/.

L'analyse est réalisée avec la [SciViews Box 2025](https://www.sciviews.org/software/svbox/) dans [Saturn Cloud](https://saturncloud.io) (Linux), utilisant le [logiciel R](https://www.r-project.org) (`r R.version.string`). Le package {pastecs} version `r packageVersion("pastecs")` est utilisé pour étudier la série temporelle.

## Analyses

<!--% Lisez bien les éléments devant guider votre analyse proposée dans le README.-->

```{r setup, include=FALSE}
# Nécessaire pour les tests SDD, ne pas utiliser dans un "vrai" projet
if (!"tools:tests" %in% search())
  source(here::here("tests/tools_tests.R"), attach(NULL, name = "tools:tests"))
# Configuration de l'environnement
SciViews::R("ts", lang="fr")
```

<!--% Ajoutez le nombre de chunks que vous souhaitez. Répartissez-vous le travail correctement. Structurez la section en partie avec des titres explicites de niveau trois.-->

### Modifications des données
```{r modif donnees}
mobility <- read("data/mobility_wallonia.rds")
mobility <- labelise(mobility,
  label= list(
  retail_and_recreation_percent_change_from_baseline = "commerces_loisirs", 
  grocery_and_pharmacy_percent_change_from_baseline = "alimentation_pharmacies", 
  parks_percent_change_from_baseline = "parcs" ,
  transit_stations_percent_change_from_baseline = "arrets transports",
  workplaces_percent_change_from_baseline = "travail",
  residential_percent_change_from_baseline ="residence"))
mobility<- rename(mobility,
  commerces_loisirs = "retail_and_recreation_percent_change_from_baseline",
  alimentation_pharmacies = "grocery_and_pharmacy_percent_change_from_baseline",
  parcs = "parks_percent_change_from_baseline",
  arrets_transports = "transit_stations_percent_change_from_baseline",
  travail = "workplaces_percent_change_from_baseline",
  residence = "residential_percent_change_from_baseline")
```

```{r}
mobility_tsbl <- tsibble::as_tsibble(mobility)
mobility_tsbl
```

### Résumé des données
```{r skim Maréva}
skimr::skim(mobility)
```

### Suppresion des données manquantes
```{r Maréva}
sdrop_na(mobility) ->mobility
```

### Raccourcissement série
```{r}
mobility <- filter(mobility, date >="2020-02-15" & date <="2021-12-31")
mobility
```

### Conversion en série temporelle et analyses
```{r ts commerce,loisir Maréva}
mobility_com_ts <- ts(mobility$commerces_loisirs, start = c(2020,46), frequency=365)
plot(mobility_com_ts)

acf_com <- acf(mobility_com_ts)

mobility_com_trend <- trend.test(mobility_com_ts, R=999)
plot(mobility_com_trend)

mobility_com_median <- tsd(mobility_com_ts, method="median", order=180 ,times=1)
plot(mobility_com_median, col=1:3)

plot(mobility_com_median, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(500,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)
```
Tout d'abord, il nous faut noter que le 33ème jour après le 15 février 2020 (début de la série) correspond au début premier confinement (18 mars 2020), son déconfinement progressif correspond au 80ème jour (4 mai 2020) et a duré +/- jusqu'au 138ème jour (1 juillet 2020). Le 261ème jour correspond au second confinement (2 novembre 2020) et son déconfinement a eu lieu au 387ème jour (8 mars 2021). A noter que les confinements et déconfinements ont été progressifs pour certains aspects, par exemple, les commerces non-essentiels ont d'abord étaient concernés alors que certains loisirs comme les cinémas ou piscines ont été impactés plus tard.

Lorsque l'on observe le graphique de l'analyse par "médianes mobiles", on apercoit une diminution brutale de la fréquentation au alentour du 30ème jour, cela correspondant au début du premier confinement, il y a ensuite une augmentation du +/-90ème jour (suite au déconfinement) au 180ème jour qui se stabilise jusqu'au 220ème jour +/- avant de rediminuer légèrement juqu'au 250ème et de nouveau se stabiliser jusqu'au 400ème jour. On observe ensuite de nouveau une augmentation qui va rester assez stable jusqu'à la fin de la série. 

Lorsque l'on analyse l'influence du COVID-19 sur la fréquentations des commerces et loisirs, nous observons que la fréquentation subit une brusque diminution au début du confinement, une très légère augmentation lors de ce confinement, puis une augmentation plus marquée aux alentours du jour du déconfinement. 
Cependant, nous observons une diminution de la fréquentation alors que le second confinement n'avait pas encore était mis en place, nous remarquons que cette diminution commence aux alentours de début Octobre, cela pourrait donc être dû au fait que les "beaux jours" disparaissent et aussi que les vacances sont finies, et donc moins de temps pour aller au cinéma, visiter un musée, aller à la piscine,...

```{r ts commerce,loisir sans wk Maréva}
# Copie de la série initiale sous une autre nom
mobw <- mobility
# Calcul des jours de la semaine
mobw$weekdays <- weekdays(as.POSIXct(mobw$date))
# Les données du week-end sont remplacées par des valeurs manquantes
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday" , 2] <- NA 
# La série temporelle est créée (début le 15 février 2020 = 46e jour de l'année 2020)
mobw_ts <- ts(mobw$commerces_loisirs, start = c(2020, 46), frequency = 365)
plot(mobw_ts)
# Aggrégation par moyenne des valeurs par semaine
mobw_ts2 <- aggregate(mobw_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(mobw_ts2)

acf_com_wd <- acf(mobw_ts2)
mobility_com_trend_wd <- trend.test(mobw_ts2, R=999)
plot(mobility_com_trend_wd)
mobility_com_median_wd <- tsd(mobw_ts2, method="median", order=180 ,times=1)
plot(mobility_com_median_wd, col=1:3)

plot(mobility_com_median_wd, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(100,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)
```

### Conversion en série temporelle et analyses
```{r ts commerce,loisir 2 Maréva}
mobility_com_moy <- tsd(mobility_com_ts, method="average", order=180 ,times=1)
plot(mobility_com_moy, col=1:4)

plot(mobility_com_moy, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(500,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)
```


```{r #joy}
mobility_grocery_pharma_ts <- ts(mobility$alimentation_pharmacies, start=2020, frequency=365)
plot(mobility_grocery_pharma_ts)

acf_grocery_pharma <- acf(mobility_grocery_pharma_ts)

mobility_grocery_pharma_trend <- trend.test(mobility_grocery_pharma_ts, R=999)
plot(mobility_grocery_pharma_trend)
abline(v=c(33,80,260,385), col="green", lwd=2)

mobility_grocery_pharma_median <- tsd(mobility_grocery_pharma_ts, method="median", order=180 ,times=1)
plot(mobility_grocery_pharma_median, col=1:4)
abline(v=c(33,80,260,385), col="green", lwd=2)

plot(mobility_grocery_pharma_median, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(500,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)


```
Concernant les trajets vers les commerces alimentaires et les pharmacies, on observe une chute brutale au démarrage du premier confinement, et une légère augmentation vers la fin du confinement. La fréquentation reste ensuite assez stable et le second confinement a un impact assez limité. Juste après la fin du second confinement, des valeurs plus élevées qui semblent correspondre à la situation avant confinements voir même plus sont observées.Les valeurs de la série passent sous la courbe rouge pendant le premier confinement, ce qui traduit des valeurs temporairement en dessous de la tendance, c'est beaucoup moins flagrant lors du second confinement.

```{r}
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday" , "alimentation_pharmacies"] <- NA

mobw_ts3 <- ts(mobw$alimentation_pharmacies, start = c(2020, 46), frequency = 365)
plot(mobw_ts)
mobw_ts4 <- aggregate(mobw_ts3, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(mobw_ts4)
```

```{r #joy 2}
mobility_parks_ts <- ts(mobility$parcs, start=2020, frequency=365)
plot(mobility_parks_ts)

acf_parks <- acf(mobility_parks_ts)

mobility_parks_trend <- trend.test(mobility_parks_ts, R=999)
plot(mobility_parks_trend)

mobility_parks_median <- tsd(mobility_parks_ts, method="median", order=180 ,times=1)
plot(mobility_parks_median, col=1:4)

plot(mobility_parks_median, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(500,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)
abline(v=c(15, 45, 75, 105, 135, 165, 195, 225, 255, 285, 315, 345, 375, 405, 435, 465, 495, 525, 555, 585, 615, 645, 695 ), col="yellow", lwd=1)
```

Concernant les parcs, on observe une chute brutale mais d'amplitude assez faible, suivie d'une augmentation, puis d'une diminution. Lors du second déconfinement la fréquentation reste assez stable, avant de réaugmenter et de rediminuer. Ces augmentations et diminutions semblent suivre les saison : les deux fois l'augmentation commence dès avril et la diminution vers début septembre. ( les barres verticales jaunes, une tout les 30 jours, représentent approximativement le début de chaque mois, la première correspondant au 1er mars 2020).Les valeurs de la série passent sous la courbe rouge pendant les deux confinements, ce qui traduit des valeurs temporairement en dessous de la tendance, c'est également le cas à partir de novembre 2021 (un peu avant 600 ème jour)


```{r}
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday" , "parcs"] <- NA 

mobw_ts5 <- ts(mobw$parcs, start = c(2020, 46), frequency = 365)
plot(mobw_ts5)
mobw_ts6 <- aggregate(mobw_ts5, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(mobw_ts6)
```

```{r #joy 3}
mobility_transport_ts <- ts(mobility$arrets_transports, start=2020, frequency=365)
plot(mobility_transport_ts)

acf_transport <- acf(mobility_transport_ts)

mobility_transport_trend <- trend.test(mobility_transport_ts, R=999)
plot(mobility_transport_trend)

mobility_transport_median <- tsd(mobility_transport_ts, method="median", order=180 ,times=1)
plot(mobility_transport_median, col=1:4)

plot(mobility_transport_median, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(500,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)

```
Les déplacements vers les arrêts de transports présentent une chute brutale au premier confinement, avant de réaugmenter progressivement. Une nouvelle diminution, cette fois plus faible et moins brusque que la première, est observée au début du second confinement. Les valeurs de la série passent sous la courbe rouge pendant les deux confinements, ce qui traduit des valeurs temporairement en dessous de la tendance.
```{r}
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday" , "arrets_transports"] <- NA

mobw_ts7 <- ts(mobw$arrets_transports, start = c(2020, 46), frequency = 365)
plot(mobw_ts7)
mobw_ts8 <- aggregate(mobw_ts7, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(mobw_ts8)
```

```{r Moussa travail}
mobility_travail_ts <- ts(mobility$travail, start = c(2020, 46), frequency = 365)
plot(mobility_travail_ts)

acf_travail <- acf(mobility_travail_ts)

mobility_travail_trend <- trend.test(mobility_travail_ts, R = 999)
plot(mobility_travail_trend)

mobility_travail_median <- tsd(mobility_travail_ts, method = "median", order = 180, times = 1)
plot(mobility_travail_median, col = 1:3)

plot(mobility_travail_median, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(500,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)
```
Cette analyse se concentre sur les déplacements de la population allant travail hors de leur domicile. La série commence en 2020, l'année de la pandémie mondiale de coronavirus, ayant nécessité un confinement de la population à partir du 18 mars 2020. Lors de cette période, les déplacements en dehors du domicile étaient fortement limités, induisant donc à une baisse du déplacement pour le travail en dehors de celui-ci (majoritairement télétravail, ou activité professionnelle impossible). 
Cependant, une hausse est observable aux alentours de mai 2020, période où le déconfinement est progressif. Cette hausse au cours du temps est confirmée par la tendance générale, qui s'étend jusqu'en 2022. 
La série composante filtrée montre que les déplacements augmentent mais de manière progressive. Quant aux résidus, les différences notables lors du début de la période d'étude renforce le fait d'une baisse suivie d'une hausse progressive, puis d'une constante. 


```{r Moussa travail sans wk}
# Les données du week-end sont remplacées par des valeurs manquantes
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday" , "travail"] <- NA

mobw_travail_ts <- ts(mobw$travail, start = c(2020, 46), frequency = 365)
plot(mobw_travail_ts)

mobw_travail_ts2 <- aggregate(mobw_travail_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(mobw_travail_ts2)
```
Puisque l'analyse précédente prenait les déplacements professionnels pour chaque jour de la semaine, incluant les week-end, il est donc normal d'observer des baisses sur 2 jours. Cette fois-ci, on se concentre sur la même étude mais en excluant les week-end. 
La baisse de mobilité au travail au début de l'année 2020 est causée par le confinement mondial, mais suite à la hausse, certaines baisses sont tout de même observables. Une fois la pandémie terminée et que les déplacements en dehors du domicile s'équilibre, il y a 2 baisses par an : au début/fin d'une année (fêtes de fin d'année), et une au milieu (vacances d'été). Même en excluant les week-end, les vacances subsistent et des baisses (légères) ont lieu tous les ans à différentes périodes, et ceux même en post pandémie.  

```{r Dany résidence}
mobility_residence_ts <- ts(mobility$residence, start = c(2020, 46), frequency = 365)
plot(mobility_residence_ts)

acf_residence <- acf(mobility_residence_ts)

mobility_residence_trend <- trend.test(mobility_residence_ts, R = 999)
plot(mobility_residence_trend)

mobility_residence_median <- tsd(mobility_residence_ts, method = "median", order = 180, times = 1)
plot(mobility_residence_median, col = 1:3)

plot(mobility_residence_median, stack=FALSE, resid=FALSE, col=1:2, leg=FALSE)
legend(500,-50, c("série", "médiane"), col=1:2, lty=1)
abline(v=c(33,80,260,385), col="green", lwd=2)
```

Lorsque l’on observe le graphique de l’analyse par « médianes-mobiles » de la série Résidence, on aperçoit tout d’abord une forte augmentation du temps passé à domicile dès le début de la série, c’est-à-dire autour du 30ème jour. Cette hausse correspond au début du premier confinement (18 mars 2020), période durant laquelle les déplacements non essentiels étaient interdits et où la population restait majoritairement chez elle. Cette augmentation se maintient jusque vers le 100ème jour.

À partir d’environ du 100ème au 200ème jour, on observe une diminution progressive du temps passé à la maison. Cela correspond au déconfinement progressif initié le 4 mai 2020, qui s’est poursuivi jusqu’au coeur de l’été (vers le 130ème–150ème jour). Durant cette période, la mobilité résidentielle diminue graduellement mais reste néanmoins supérieure au niveau de référence, en raison du maintien de certaines restrictions ainsi que du télétravail encore largement pratiqué.

Peu après le 200ème-210ème jour, on constate une nouvelle augmentation du temps passé à domicile. Cette hausse est progressive et se poursuit jusqu’à environ le 250ème, voire le 300ème jour. Cette tendance ascendante correspond à la période précédant le second confinement, puis au second confinement lui-même (à partir du 2 novembre 2020), durant lequel les déplacements furent à nouveau restreints.

Il faut également noter que tout au long de la série, les variations de courte durée correspondent aux fluctuations quotidiennes et hebdomadaires habituelles, fortement influencées par les différentes phases sanitaires. La tendance générale met clairement en évidence les impacts successifs des périodes de confinement et de déconfinement sur la mobilité résidentielle en Wallonie.

```{r Dany Résidence sans wk}
# Les données du week-end sont remplacées par des valeurs manquantes
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday" , "residence"] <- NA

mobw_residence_ts <- ts(mobw$residence, start = c(2020, 46), frequency = 365)
plot(mobw_residence_ts)

mobw_residence_ts2 <- aggregate(mobw_residence_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(mobw_residence_ts2)
```

Après avoir retiré les week-ends, la série Résidence devient plus lissée et présente moins de fluctuations brusques, ce qui permet de mieux observer la tendance générale, même si la forme globale reste la même que dans la série complète. Les effets des confinements sont toujours visibles, mais les variations d’un jour à l’autre sont moins fortes. Au final, ça ne change pas fondamentalement l’interprétation.

## Conclusion

<!--% Lorsque toutes les analyses sont réalisées, terminez ce bloc-notes avec 3 à 6 phrases de conclusion en rapport avec ce que vous avez observé dans vos analyses. Quels sont les éléments les plus pertinents que vous retenez ? -->

Lorsque l'on analyse l'influence du COVID-19 sur la fréquentation des commerces et loisirs, nous observons une corrélation entre les 2 lors du 1er confinement et du 1er déconfinement, cependant, nous observons une diminution de la fréquentation alors que le second confinement n'avait pas encore était mis en place, nous remarquons que cette diminution commence aux alentours de début Octobre, cela pourrait donc être dû au fait que les "beaux jours" disparaissent et aussi que les vacances sont finies, et donc moins de temps pour aller au cinéma, visiter un musée, aller à la piscine,...Il ne faut donc oublier que d'autres facteurs sont à prendre en compte sur la fréquentation des ces lieux.
